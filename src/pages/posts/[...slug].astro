---
import Layout from '../../layouts/Layout.astro';
import Article from '../../components/Article.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('posts');
  return posts.map(post => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();

const absoluteImageUrl = post.data.image
  ? post.data.image.startsWith('http') 
    ? post.data.image 
    : `https://www.jonathanmwaniki.co.ke${post.data.image.startsWith('/') ? '' : '/'}${post.data.image}`
  : 'https://www.jonathanmwaniki.co.ke/default-og-image.jpg';
---

<Layout 
  title={post.data.title} 
  description={post.data.description}
  image={absoluteImageUrl}
  canonical={`https://www.jonathanmwaniki.co.ke/posts/${post.slug}`}
  meta={[
    { name: 'og:title', content: post.data.title },
    { name: 'og:description', content: post.data.description },
    { name: 'og:type', content: 'article' },
    { name: 'og:url', content: `https://www.jonathanmwaniki.co.ke/posts/${post.slug}` },
    { name: 'og:image', content: absoluteImageUrl },
    { name: 'og:image:alt', content: post.data.imageAlt || post.data.title },
    { name: 'og:site_name', content: "The Mwaniki's Report" },
    { name: 'twitter:card', content: 'summary_large_image' },
    { name: 'twitter:title', content: post.data.title },
    { name: 'twitter:description', content: post.data.description },
    { name: 'twitter:image', content: absoluteImageUrl },
    { name: 'twitter:image:alt', content: post.data.imageAlt || post.data.title },
    { name: 'twitter:site', content: '@maestropuns' },
  ]}
>
  <!-- Top Ad -->
  <script type="text/javascript">
    atOptions = {
      'key' : '1610960d9ced232cc76d8f5510ee4608',
      'format' : 'iframe',
      'height' : 60,
      'width' : 468,
      'params' : {}
    };
  </script>
  <script type="text/javascript" src="//www.highperformanceformat.com/1610960d9ced232cc76d8f5510ee4608/invoke.js"></script>

  <div class="reading-progress">
    <div class="reading-progress-bar" id="progress-bar"></div>
  </div>

  <div class="post-container">
    <a href="/" class="back-link">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
      </svg>
      Back to all posts
    </a>
    
    {post.data.draft && (
      <div class="draft-notice">
        ⚠️ This is a draft article and may contain incomplete content
      </div>
    )}
    
    <article>
      <header class="post-header">
        <div class="post-meta">
          <span class="post-category">{post.data.category}</span>
          <time class="post-date" datetime={post.data.date}>
            {new Date(post.data.date).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            })}
          </time>
        </div>
        
        <h1 class="post-title">{post.data.title}</h1>
        
        {post.data.description && (
          <p class="post-description">{post.data.description}</p>
        )}
      </header>
      
      {post.data.image && (
        <div class="post-image-container">
          <img 
            src={post.data.image}
            alt={post.data.imageAlt || post.data.title}
            class="post-featured-image"
          />
          <div class="post-image-overlay"></div>
        </div>
      )}
      
      <!-- Middle Ad (After Featured Image) -->
      <script type="text/javascript">
        atOptions = {
          'key' : '1610960d9ced232cc76d8f5510ee4608',
          'format' : 'iframe',
          'height' : 60,
          'width' : 468,
          'params' : {}
        };
      </script>
      <script type="text/javascript" src="//www.highperformanceformat.com/1610960d9ced232cc76d8f5510ee4608/invoke.js"></script>
      
      <div class="article-wrapper">
        <Article>
          <Content />
        </Article>
      </div>
    </article>
    
    <!-- Bottom Ad (Before Footer) -->
    <script type="text/javascript">
      atOptions = {
        'key' : '1610960d9ced232cc76d8f5510ee4608',
        'format' : 'iframe',
        'height' : 60,
        'width' : 468,
        'params' : {}
      };
    </script>
    <script type="text/javascript" src="//www.highperformanceformat.com/1610960d9ced232cc76d8f5510ee4608/invoke.js"></script>
    
    <footer class="post-footer">
      <div class="post-footer-content">
        <h3>Share this article</h3>
        <p>Found this article helpful? Share it with your network!</p>
        <div class="social-share">
          <!-- X (Twitter) Button -->
          <a 
            href={`https://x.com/intent/tweet?text=${encodeURIComponent(post.data.title)}&url=${encodeURIComponent(`https://www.jonathanmwaniki.co.ke/posts/${post.slug}`)}`}
            target="_blank"
            rel="noopener noreferrer"
            class="share-button x"
            aria-label="Share on X"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
              <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
            </svg>
            X
          </a>
          
          <!-- LinkedIn Button -->
          <a 
            href={`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(`https://www.jonathanmwaniki.co.ke/posts/${post.slug}`)}`}
            target="_blank"
            rel="noopener noreferrer"
            class="share-button linkedin"
            aria-label="Share on LinkedIn"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
              <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452z"/>
            </svg>
            LinkedIn
          </a>
          
          <!-- Facebook Button -->
          <a 
            href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(`https://www.jonathanmwaniki.co.ke/posts/${post.slug}`)}`}
            target="_blank"
            rel="noopener noreferrer"
            class="share-button facebook"
            aria-label="Share on Facebook"
          >
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
              <path d="M22.675 0H1.325C.593 0 0 .593 0 1.325v21.351C0 23.407.593 24 1.325 24H12.82v-9.294H9.692v-3.622h3.128V8.413c0-3.1 1.893-4.788 4.659-4.788 1.325 0 2.463.099 2.795.143v3.24l-1.918.001c-1.504 0-1.795.715-1.795 1.763v2.313h3.587l-.467 3.622h-3.12V24h6.116c.73 0 1.323-.593 1.323-1.325V1.325C24 .593 23.407 0 22.675 0z"/>
            </svg>
            Facebook
          </a>
        </div>
      </div>
    </footer>
  </div>

  <style>
    /* BBC-Inspired Button Styles */
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      border: 1px solid #BB1919;
      border-radius: 4px;
      background: #FFFFFF;
      color: #BB1919;
      font-family: 'ReithSans', 'Helvetica', 'Arial', sans-serif;
      font-size: 0.875rem;
      font-weight: 500;
      text-decoration: none;
      cursor: pointer;
      transition: background 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
    }

    .back-link:hover {
      background: #BB1919;
      color: #FFFFFF;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .back-link:focus {
      outline: 2px solid #BB1919;
      outline-offset: 2px;
      border-radius: 4px;
    }

    .back-link svg {
      width: 16px;
      height: 16px;
      stroke: currentColor;
    }

    .share-button {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      border: 1px solid #E0E0E0;
      border-radius: 4px;
      background: #FFFFFF;
      color: #141414;
      font-family: 'ReithSans', 'Helvetica', 'Arial', sans-serif;
      font-size: 0.875rem;
      font-weight: 500;
      text-decoration: none;
      cursor: pointer;
      transition: background 0.3s ease, box-shadow 0.3s ease;
    }

    .share-button:hover {
      background: #F6F6F6;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .share-button:focus {
      outline: 2px solid #BB1919;
      outline-offset: 2px;
      border-radius: 4px;
    }

    .share-button svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }

    .share-button.x:hover {
      color: #000000;
    }

    .share-button.linkedin:hover {
      color: #0A66C2;
    }

    .share-button.facebook:hover {
      color: #1877F2;
    }

    /* Ad Styling */
    script[src*="highperformanceformat"] {
      display: block;
      margin: 2rem auto;
      text-align: center;
      background: transparent;
    }

    @media (prefers-reduced-motion: reduce) {
      .back-link,
      .share-button {
        transition: none;
      }
    }
  </style>

  <script>
    // Reading progress bar
    function updateReadingProgress() {
      const article = document.querySelector('article');
      const progressBar = document.getElementById('progress-bar');
      
      if (!article || !progressBar) return;
      
      const articleTop = article.offsetTop;
      const articleHeight = article.offsetHeight;
      const windowHeight = window.innerHeight;
      const scrollTop = window.scrollY;
      
      const articleStart = articleTop - windowHeight;
      const articleEnd = articleTop + articleHeight;
      
      if (scrollTop < articleStart) {
        progressBar.style.width = '0%';
      } else if (scrollTop > articleEnd) {
        progressBar.style.width = '100%';
      } else {
        const progress = (scrollTop - articleStart) / (articleEnd - articleStart);
        progressBar.style.width = Math.min(100, Math.max(0, progress * 100)) + '%';
      }
    }
    
    window.addEventListener('scroll', updateReadingProgress);
    window.addEventListener('resize', updateReadingProgress);
    updateReadingProgress();
  </script>
</Layout>