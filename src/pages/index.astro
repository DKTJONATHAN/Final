---
// src/pages/index.astro
import Layout from '../components/Layout.astro';
import { getCollection } from 'astro:content';

// Fetch all posts sorted by date (newest first)
const allPosts = await getCollection('posts', ({ data }) => {
  return !data.draft;
}).then(posts => posts.sort((a, b) => 
  new Date(b.data.publishDate) - new Date(a.data.publishDate)
));

// Extract first image from post content
function getFirstImage(post) {
  const imgRegex = /!\[.*?\]\((.*?)\)/;
  const match = post.body.match(imgRegex);
  return match ? match[1] : post.data.image?.src || '/images/default-news.jpg';
}
---

<Layout title="Latest News">
  <div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-8 border-b pb-2">Breaking News</h1>
    
    <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
      {allPosts.map(post => (
        <a 
          href={`/${post.slug}`} 
          class="group block overflow-hidden rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300"
        >
          <div class="h-48 overflow-hidden">
            <img 
              src={getFirstImage(post)} 
              alt={post.data.image?.alt || post.data.title}
              class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
              loading="lazy"
            />
          </div>
          <div class="p-4">
            <div class="flex justify-between items-center mb-2">
              <span class="text-sm text-gray-500">
                {new Date(post.data.publishDate).toLocaleDateString('en-US', {
                  year: 'numeric',
                  month: 'short',
                  day: 'numeric'
                })}
              </span>
              <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">
                {post.data.category}
              </span>
            </div>
            <h2 class="text-xl font-bold mb-2 group-hover:text-blue-600">
              {post.data.title}
            </h2>
            <p class="text-gray-600 line-clamp-2">
              {post.data.description}
            </p>
          </div>
        </a>
      ))}
    </div>
  </div>
</Layout>